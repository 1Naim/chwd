#!/bin/bash

### Module Functions ###

MHWD_HEADING()
{
	echo '##' > "$1"
	echo '## Generated by mhwd - Manjaro Hardware Detection' >> "$1"
	echo '##' >> "$1"
	echo ' ' >> "$1"
	echo ' ' >> "$1"
}

MHWD_PCI_BUS_ID()
{
	echo "$(lspci -nmm | grep '$1.*$2' | cut -d" " -f1 | sed "s|\.|:|g")"
}

MHWD_CHECK_PKGS()
{
	local REMOVEPKGS=""

    for PKG in ${PACKAGES} ; do
        for RMPKG in $(pacman -Qq | grep ${PKG}) ; do
            if [ "${PKG}" == "${RMPKG}" ] ; then
               REMOVEPKGS="${REMOVEPKGS} ${RMPKG}"
            fi
        done
    done

    PACKAGES="${REMOVEPKGS}"
}

# Make them readonly
declare -fr MHWD_HEADING MHWD_PCI_BUS_ID

### Main ###
ARCH="$(uname -m)"
PARAM=$#
INCLUDEPATH="/var/lib/mhwd/scripts/include"
PACMAN="pacman --noconfirm --noprogress"
SYNC=""
INSTALL=""
REMOVE=""
CONFIGPATH=""
CACHEPATH="/var/cache/pacman/pkg"
PMCONFIG="/etc/pacman.conf"
PMROOT="/"
PACKAGES=""


if [ "${PARAM}" -lt 1 ]; then
	echo "No Arguments!"
	exit 1
fi

for (( I=1; $I <= $PARAM; I++ ))
do
	case "$1" in
		--install)
			INSTALL="true"
			;;
		--remove)
			REMOVE="true"
			;;
		--sync)
			SYNC="y"
			;;
		--cachedir)
			shift
			CACHEPATH="$1"
			;;
		--config)
			shift
			CONFIGPATH="$1"
			;;
		--pmconfig)
			shift
			PMCONFIG="$1"
			;;
		--pmroot)
			shift
			PMROOT="$1"
			;;
		"")	;;
		*)
			echo "Wrong Argument: $1"
			exit 1
			;;
	esac

	shift
done

# Set final variables
PACMAN="${PACMAN} --cachedir ${CACHEPATH} --config ${PMCONFIG} --root ${PMROOT}"

if [ "${CONFIGPATH}" != "" ] && [ -e "${CONFIGPATH}" ]; then
	. "${CONFIGPATH}"

	# Now include additional functions for this group
	for classid in "${CLASSIDS}"
	do
		if [ -e "${INCLUDEPATH}/${classid}" ]; then
			. "${INCLUDEPATH}/${classid}"
		fi
	done
else
	exit 1
fi

if [ "${INSTALL}" == "true" ]; then
	# Run preinstall function
	if [ "`grep "pre_install" "${CONFIGPATH}" | cut -d"#" -f1 | cut -d"(" -f1 | grep "pre_install"`" == "pre_install" ]; then
	   pre_install
	fi

	PACKAGES=""

	# Remove conflicts
	if [ "${CONFLICTS}" != "" ]; then
		PACKAGES="${CONFLICTS}"
	fi
	if [ "${ARCH}" == "i686" ] && [ "${CONFLICTS_32}" != "" ]; then
		PACKAGES="${PACKAGES} ${CONFLICTS_32}"
	fi
	if [ "${ARCH}" == "x86_64" ] && [ "${CONFLICTS_64}" != "" ]; then
		PACKAGES="${PACKAGES} ${CONFLICTS_64}"
	fi

        # Check if packages are installed
        MHWD_CHECK_PKGS

	if [ "${PACKAGES}" != "" ]; then
		${PACMAN} -Rs ${PACKAGES}
		if [ "$?" -ne "0" ]; then
			echo "Error: pacman failed!"
			exit 1
		fi
	fi

	PACKAGES=""

	# Install dependencies
	if [ "${DEPENDS}" != "" ]; then
		PACKAGES="${DEPENDS}"
	fi
	if [ "${ARCH}" == "i686" ] && [ "${DEPENDS_32}" != "" ]; then
		PACKAGES="${PACKAGES} ${DEPENDS_32}"
	fi
	if [ "${ARCH}" == "x86_64" ] && [ "${DEPENDS_64}" != "" ]; then
		PACKAGES="${PACKAGES} ${DEPENDS_64}"
	fi

	if [ "${PACKAGES}" != "" ]; then
		${PACMAN} --needed -S${SYNC} ${PACKAGES}
		if [ "$?" -ne "0" ]; then
			echo "Error: pacman failed!"
			exit 1
		fi
	fi

	# Run postinstall function
	if [ "`grep "post_install" "${CONFIGPATH}" | cut -d"#" -f1 | cut -d"(" -f1 | grep "post_install"`" == "post_install" ]; then
	   post_install
	fi
fi


if [ "${REMOVE}" == "true" ]; then
	# Run preremove function
	if [ "`grep "pre_remove" "${CONFIGPATH}" | cut -d"#" -f1 | cut -d"(" -f1 | grep "pre_remove"`" == "pre_remove" ]; then
	   pre_remove
	fi

	PACKAGES=""

	# Remove dependencies
	if [ "${DEPENDS}" != "" ]; then
		PACKAGES="${DEPENDS}"
	fi
	if [ "${ARCH}" == "i686" ] && [ "${DEPENDS_32}" != "" ]; then
		PACKAGES="${PACKAGES} ${DEPENDS_32}"
	fi
	if [ "${ARCH}" == "x86_64" ] && [ "${DEPENDS_64}" != "" ]; then
		PACKAGES="${PACKAGES} ${DEPENDS_64}"
	fi

        # Check if packages are installed
        MHWD_CHECK_PKGS

	if [ "${PACKAGES}" != "" ]; then
		${PACMAN} -Rs ${PACKAGES}
		if [ "$?" -ne "0" ]; then
			echo "Error: pacman failed!"
			exit 1
		fi
	fi

	# Run postremove function
	if [ "`grep "post_remove" "${CONFIGPATH}" | cut -d"#" -f1 | cut -d"(" -f1 | grep "post_remove"`" == "post_remove" ]; then
	   post_remove
	fi
fi

exit 0
