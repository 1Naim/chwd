#!/bin/bash

PARAM=$#
CHECKCONFIG="false"
SETGL=""
SETXORGCONF=""



# param 1: modules to load
# param 2: blacklisted modules
set_modules() {
	echo "##" > "/etc/modprobe.d/mhwd-gpu.conf"
	echo "## Generated by mhwd - Manjaro Hardware Detection" >> "/etc/modprobe.d/mhwd-gpu.conf"
	echo "##" >> "/etc/modprobe.d/mhwd-gpu.conf"
	echo " " >> "/etc/modprobe.d/mhwd-gpu.conf"

	for module in $2
	do
		echo "blacklist ${module}" >> "/etc/modprobe.d/mhwd-gpu.conf"
		modprobe -r ${module}
	done


	echo "##" > "/etc/modules-load.d/mhwd-gpu.conf"
	echo "## Generated by mhwd - Manjaro Hardware Detection" >> "/etc/modules-load.d/mhwd-gpu.conf"
	echo "##" >> "/etc/modules-load.d/mhwd-gpu.conf"
	echo " " >> "/etc/modules-load.d/mhwd-gpu.conf"

	for module in $1
	do
		echo "${module}" >> "/etc/modules-load.d/mhwd-gpu.conf"
		modprobe ${module}
	done
}



# param 1: Xorg configuration file
set_xorg()
{
	if [ -e "/etc/X11/xorg.conf" ]; then
		rm "/etc/X11/xorg.conf"
	fi

	if [ -e "$1" ]; then
		ln -sf "$1" "/etc/X11/xorg.conf"

		echo "xorg configuration file: '$1'"
	else
		echo "warning: could not find '$1'!"
	fi
}



# param 1: libGl path
# param 2: libglx path
set_Gl() {
	if [ -e "$1" ]; then
		rm /usr/lib/libGL.so
		rm /usr/lib/libGL.so.1
		rm /usr/lib/libGL.so.1.2

		ln -sf "$1" /usr/lib/libGL.so
		ln -sf "$1" /usr/lib/libGL.so.1
		ln -sf "$1" /usr/lib/libGL.so.1.2

		echo "libGl: '$1'"
	else
		echo "warning: could not find '$1'!"
	fi

	if [ -e "$2" ]; then
		rm /usr/lib/xorg/modules/extensions/libglx.so
		ln -sf "$2" /usr/lib/xorg/modules/extensions/libglx.so

		echo "libglx: '$2'"
	else
		echo "warning: could not find '$2'!"
	fi
}



print_help()
{
	echo "mhwd-gpu [OPTION] [...]"
	echo ""
	echo "   --help                          show help"
	echo "   --check                         check for invalid symlinks and repair"
	echo "   --setgl [mesa/nvidia/catalyst]  set libgl and libglx"
	echo "   --setxorg [PATH]                set xorg configuration file"
	echo ""
}






if [ "${PARAM}" -lt 1 ]; then
	echo "error: no arguments!"
	echo ""
	print_help
	exit 1
fi


for (( I=1; $I <= $PARAM; I++ ))
do
	case "$1" in
		--help)
			print_help
			exit 0
			;;
		--check)
			CHECKCONFIG="true"
			;;
		--setgl)
			shift
			SETGL="$1"
			;;
		--setxorg)
			shift
			SETXORGCONF="$1"
			;;
		"")	;;
		*)
			echo "error: invalid argument: $1"
			echo ""
			print_help
			exit 1
			;;
	esac

	shift
done



# Check root
if [[ $EUID -ne 0 ]]; then
   echo "error: you cannot perform this operation unless you are root." 1>&2
   exit 1
fi



# Set libGl and libglx
if [ "${SETGL}" == "mesa" ] || [ "${SETGL}" == "default" ]; then
	set_modules
	set_Gl "/usr/lib/libGL.so.mesa" "/usr/lib/xorg/modules/extensions/libglx.xorg"
elif [ "${SETGL}" == "nvidia" ]; then
	set_modules "" "nouveau"
	set_Gl "/usr/lib/libGL.so.nvidia" "/usr/lib/xorg/modules/extensions/libglx.so.nvidia"
elif [ "${SETGL}" == "catalyst" ] || [ "${SETGL}" == "ati" ]; then
	set_modules "" "radeon"
	set_Gl "/usr/lib/libGL.so.catalyst" "/usr/lib/xorg/modules/extensions/libglx.so.catalyst"
elif [ "${SETGL}" != "" ]; then
	echo "error: invalid argument '${SETGL}'"
	exit 1
fi



# Set xorg configuration file
if [ "${SETXORGCONF}" != "" ]; then
	set_xorg "${SETXORGCONF}"
fi



# Check config
if [ "${CHECKCONFIG}" == "true" ]; then
	if [ -L "/etc/X11/xorg.conf" -a ! -e "/etc/X11/xorg.conf" ]; then
		echo "'/etc/X11/xorg.conf' symlink is invalid! Removing it..."

		if [ -e "/etc/X11/xorg.conf" ]; then
			rm "/etc/X11/xorg.conf"
		fi
	else
		echo "xorg configuration symlink valid..."
	fi

	if [ ! -e "/usr/lib/libGL.so" ] || [ ! -e "/usr/lib/xorg/modules/extensions/libglx.so" ]; then
		echo "libGl and libglx symlinks are invalid!"
		echo "Falling back to default..."

		set_modules
		set_Gl "/usr/lib/libGL.so.mesa" "/usr/lib/xorg/modules/extensions/libglx.so.mesa"
	else
		echo "libGl and libglx symlinks valid..."
	fi
fi



exit 0
